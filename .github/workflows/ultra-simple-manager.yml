name: Ultra Simple Manager

on:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'Runtime (minutes)'
        required: false
        default: '15'

jobs:
  run-manager:
    runs-on: ubuntu-latest
    timeout-minutes: 1440
    
    steps:
      - name: Login & Pull Latest Image
        run: |
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u hamid323232 --password-stdin
          
          # Remove any cached images first
          docker rmi hamid323232/mcp-manager-hybrid:latest 2>/dev/null || true
          
          # Pull fresh image (always pull, no cached layers)
          docker pull hamid323232/mcp-manager-hybrid:latest
          
          echo "âœ… Pulled latest image"
          docker images | grep mcp-manager-hybrid | head -3

      - name: Start Manager & Monitor
        run: |
          MANAGER_ID="manager-github-${{ github.run_id }}-$(date +%s)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Manager ID: $MANAGER_ID"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Start manager
          docker run -d \
            --name manager \
            -e MANAGER_ID="$MANAGER_ID" \
            -e API_URL="http://165.232.134.47:4001" \
            -e NATS_HOST="165.232.134.47" \
            hamid323232/mcp-manager-hybrid:latest
          
          echo "â³ Waiting 30 seconds for startup..."
          sleep 30
          
          echo ""
          echo "ğŸ“‹ Initial logs:"
          docker logs manager 2>&1 | tail -25
          
          echo ""
          echo "ğŸ”„ Manager running for ${{ github.event.inputs.runtime_minutes }} minutes..."
          sleep $((${{ github.event.inputs.runtime_minutes }} * 60))
          
          echo ""
          echo "ğŸ“‹ Final logs:"
          docker logs manager 2>&1 | tail -50
          
          docker stop manager || true
